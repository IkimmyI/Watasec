<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watasec</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--muted:#9aa4bf;--accent:#7dd3fc}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#071024,#031027); color:#e6eef8; padding:28px}
    .wrap{max-width:1000px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    header h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:14px}
    .card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,0.6);cursor:pointer;transition:transform .14s}
    .card:hover{transform:translateY(-6px)}
    .cover{height:140px;background:#061222;background-size:cover;background-position:center}
    .meta{padding:12px}
    .meta h3{margin:0 0 8px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .excerpt{margin-top:8px;color:#d7e3fbcc;font-size:14px}
    #postView{display:none}
    #postView .post{background:var(--card);padding:20px;border-radius:10px}
    .back{display:inline-block;margin-bottom:10px;text-decoration:none;color:var(--accent)}
    img.responsive{max-width:100%;height:auto;border-radius:6px}
    pre{background:#000a12;padding:12px;border-radius:8px;overflow:auto}
#postContent img,
#postContent video,
#postContent iframe,
#postContent table {
  max-width: 100% !important;
  width: auto !important;
  height: auto !important;
  display: block;
  box-sizing: border-box;
}

#postContent,
#postContent p,
#postContent li {
  overflow-wrap: break-word;
  word-wrap: break-word;
  word-break: break-word;
}

#postContent pre {
  overflow-x: auto;
  white-space: pre;
}

html, body {
  max-width: 100%;
  overflow-x: hidden;
}
    @media (max-width:600px){body{padding:12px}.cover{height:110px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>0xKimmy Articles Website</h1>
      <small class="muted">This website features articles about Cyber Security, SOC Analysis, and Automation.</small>
    </header>

    <main id="listView">
      <div id="cards" class="grid"></div>
    </main>

    <section id="postView">
      <a href="#" id="backBtn" class="back">← back to list</a>
      <div id="postContent" class="post"></div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
  
    const cardsEl = document.getElementById('cards');
    const postView = document.getElementById('postView');
    const listView = document.getElementById('listView');
    const postContent = document.getElementById('postContent');
    const backBtn = document.getElementById('backBtn');

    let POSTS = [];

    function formatDate(s){ try{ return new Date(s).toLocaleDateString() }catch(e){return s} }

    async function loadIndex(){
      try{
        const res = await fetch('posts/posts.json');
        if(!res.ok) throw new Error('posts.json not found');
        POSTS = await res.json();
        renderCards();
        handleRouting();
      }catch(e){
        cardsEl.innerHTML = `<div style="grid-column:1/-1;padding:30px;background:rgba(0,0,0,0.2);border-radius:8px">Could not load posts.json — add <code>/posts/posts.json</code> to your repo. Error: ${e.message}</div>`;
      }
    }

    function renderCards(){
      cardsEl.innerHTML = POSTS.map(p => `
        <article class="card" data-slug="${p.slug}" onclick="openPost('${p.slug}')">
          <div class="cover" style="background-image:url('${p.cover || ''}')"></div>
          <div class="meta">
            <h3>${p.title}</h3>
            <div class="muted">${formatDate(p.date)} • ${p.slug}</div>
            <div class="excerpt">${p.excerpt || ''}</div>
          </div>
        </article>
      `).join('');
    }

    async function openPost(slug){
      const post = POSTS.find(p => p.slug === slug);
      if(!post) return alert('post not found');
      history.pushState({post:slug}, '', `#post=${slug}`);
      showPost(post);
    }

    async function showPost(post){
      listView.style.display = 'none';
      postView.style.display = 'block';
      postContent.innerHTML = '<em>loading…</em>';
      try{
        const res = await fetch(post.file.replace(/^\/+/, ''));
        if(!res.ok) throw new Error('markdown not found');
        let md = await res.text();
        let html = marked.parse(md);

        const postDir = post.file.includes('/') ? post.file.substring(0, post.file.lastIndexOf('/')+1) : '';
        html = html.replace(/(<img[^>]+src=")(?!(https?:|\/))([^\"]+)(")/g, (m,a,b,c,d)=> a + postDir + c + d);

        html = html.replace(/(<a[^>]+href=")(?!(https?:|mailto:|\/))([^\"]+)(")/g, (m,a,b,c,d)=> a + postDir + c + d);
        postContent.innerHTML = `<h2>${post.title}</h2><div class="muted">${formatDate(post.date)}</div><hr>` + html;
      }catch(e){ postContent.innerHTML = `<div class="muted">Error loading post: ${e.message}</div>` }
    }

    function closePost(){
      history.pushState({}, '', window.location.pathname);
      postView.style.display = 'none';
      listView.style.display = 'block';
    }

    window.addEventListener('popstate', () => { handleRouting(); });
    window.addEventListener('hashchange', () => { handleRouting(); });

    function handleRouting(){
      const h = location.hash || '';
      if(h.startsWith('#post=')){ const slug = h.split('=')[1]; const post = POSTS.find(p=>p.slug===slug); if(post) showPost(post); }
      else closePost();
    }

    backBtn.addEventListener('click', (e)=>{ e.preventDefault(); closePost(); });

    loadIndex();
  </script>
</body>
</html>
